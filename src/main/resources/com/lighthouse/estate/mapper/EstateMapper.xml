<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lighthouse.estate.mapper.EstateMapper">

    <resultMap id="EstateMap" type="com.lighthouse.estate.entity.Estate" autoMapping="true">
        <id property="id" column="id" />
    </resultMap>

    <resultMap id="EstateSalesMap" type="com.lighthouse.estate.entity.EstateSales" autoMapping="true">
        <id property="id" column="id" />
    </resultMap>

        <!-- 위도/경도에 해당하는 건물 정보 조회 (단일 건물) -->
    <select id="getEstateByLatLng" resultMap="EstateMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_TBL} 
        WHERE
            latitude BETWEEN #{lat} - 0.0002 AND #{lat} + 0.0002
          AND longitude BETWEEN #{lng} - 0.0002 AND #{lng} + 0.0002
        LIMIT 1
    </select>

    <select id="getEstateByElement" resultMap="EstateMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_TBL}
        WHERE 1=1
            <if test="id != null">
                AND `id` = #{id}
            </if>
            <if test="sggCd != null">
                AND `sgg_cd` = #{sggCd}
            </if>
            <if test="umdNm != null">
                AND `umd_nm` = #{umdNm}
            </if>
            <if test="jibun != null">
                AND `jibun` = #{jibun}
            </if>
            <if test="buildingName != null">
                AND `building_name` = #{buildingName}
            </if>
            <if test="mhouseType != null">
                AND `mhouse_type` = #{mhouseType}
            </if>
            <if test="shouseType != null">
                AND `shouse_type` = #{shouseType}
            </if>
            <if test="buildYear != null">
                AND `build_year` = #{buildYear}
            </if>
            <if test="jibunAddr != null">
                AND `jibun_addr` = #{jibunAddr}
            </if>
            <if test="latitude != null">
                AND latitude BETWEEN #{lat} - 0.0002 AND #{lat} + 0.0002
            </if>
            <if test="longitude != null">
                AND longitude BETWEEN #{lng} - 0.0002 AND #{lng} + 0.0002
            </if>
    </select>

    <select id="getEstateSalesByElement" resultMap="EstateSalesMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_SALES_TBL}
        WHERE 1=1
            <if test="id != null">
                AND `id` = #{id}
            </if>
            <if test="estateId != null">
                AND `estate_id` = #{estateId}
            </if>
            <if test="dealYear != null">
                AND `deal_year` = #{dealYear}
            </if>
            <if test="dealMonth != null">
                AND `deal_month` = #{dealMonth}
            </if>
            <if test="dealDay != null">
                AND `deal_day` = #{dealDay}
            </if>
            <if test="dealAmount != null">
                AND `deal_amount` = #{dealAmount}
            </if>
            <if test="deposit != null">
                AND `deposit` = #{deposit}
            </if>
            <if test="monthlyRent != null">
                AND `monthly_rent` = #{monthlyRent}
            </if>
            <if test="tradeType != null">
                AND `trade_type` = #{tradeType}
            </if>
    </select>

    <!-- 주변 건물 찾기 -->
    <select id="getNearyByEstate" resultMap="EstateMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_TBL} 
        WHERE
            latitude BETWEEN #{lat} - 0.002 AND #{lat} + 0.002
          AND longitude BETWEEN #{lng} - 0.002 AND #{lng} + 0.002
        LIMIT 1
    </select>

    <!-- estate ID로 건물 정보 조회 -->
    <select id="getEstateById" resultMap="EstateMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_TBL}
        WHERE
            id = #{estateId}
    </select>

    <!-- 건물 ID로 매매 정보 조회 -->
    <select id="getSalesByEstateId" resultMap="EstateSalesMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_SALES_TBL} 
        WHERE
            estate_id = #{estateId}
    </select>

    <!-- 지도 사각형 영역 내 건물들 정보 조회 (다건 조회)-->
    <select id="getEstateBySqaure" resultMap="EstateMap">
        SELECT
            *
        FROM
            ${ESTATE_API_INTEGRATION_TBL}
        WHERE
            latitude BETWEEN #{minLat} AND #{maxLat}
          AND longitude BETWEEN #{minLng} AND #{maxLng}
    
    </select>

    <!-- 지역코드와 읍면동명으로 건물 정보 목록 조회 -->
    <select id="getBuildingInfosByRegionCodeAndDongName" parameterType="String" resultType="com.lighthouse.estate.dto.BuildingInfoDto">
        SELECT DISTINCT 
            building_name as buildingName,
            latitude,
            longitude,
            jibun_addr as jibunAddr
        FROM ${ESTATE_API_INTEGRATION_TBL}
        WHERE sgg_cd = #{regionCode} AND umd_nm = #{dongName}
        ORDER BY building_name
    </select>

</mapper> 