<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lighthouse.alarm.mapper.AlarmMapper">

    <!-- 알림 저장 -->
    <insert id="insertAlarm" parameterType="com.lighthouse.alarm.entity.Alarms">
        INSERT INTO alarm_tbl(member_id,type,text,reg_ip,reg_date,is_checked,get_alarm)
        VALUES(#{alarm.memberId},#{alarm.type},#{alarm.text},#{alarm.regIp},#{alarm.regDate},#{alarm.isChecked},#{alarm.getAlarm})
    </insert>

    <!-- 알림 설정 변경 (get_alarm 업데이트) -->
    <update id="updateAlarmSetting" parameterType="map">
        UPDATE alarm_tbl
        SET get_alarm = #{getAlarm}
        WHERE member_id = #{memberId}
        AND type = #{alarmType}
    </update>

    <!-- 제공 받을 알림 리스트 조회 (get_alarm=1이고 is_checked=0인 것들) -->
    <select id="getAlarmList" resultType="com.lighthouse.alarm.dto.AlarmResponseDto">
        SELECT 
            id,
            member_id as memberId,
            type,
            text,
            DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i:%s') as regDate,
            is_checked as isChecked,
            get_alarm as getAlarm
        FROM alarm_tbl
        WHERE member_id = #{memberId}
        AND get_alarm = 1
        AND is_checked = 0
        ORDER BY reg_date DESC
    </select>
    
    <!-- 모든 알림 조회 (디버깅용) -->
    <select id="getAllAlarmsByMember" resultType="com.lighthouse.alarm.dto.AlarmResponseDto">
        SELECT 
            id,
            member_id as memberId,
            type,
            text,
            DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i:%s') as regDate,
            is_checked as isChecked,
            get_alarm as getAlarm
        FROM alarm_tbl
        WHERE member_id = #{memberId}
        ORDER BY reg_date DESC
    </select>

    <!-- 알림 읽음 처리 (is_checked를 1로 변경) -->
    <update id="setAlarmRead">
        UPDATE alarm_tbl
        SET is_checked = 1
        WHERE member_id = #{memberId}
        AND id = #{alarmId}
    </update>
    
    <!-- 특정 사용자의 만료 예정 계약 조회 -->
    <select id="getExpiringContractsByUser" resultType="map">
        SELECT 
            user_id as member_id,
            building_name as property_address
        FROM myhome_tbl
        WHERE user_id = #{memberId}
        AND contract_end = DATE_ADD(CURDATE(), INTERVAL #{daysLeft} DAY)
        AND is_delete = 1
    </select>
    
    <!-- 디버깅용: 사용자의 모든 집 정보 조회 -->
    <select id="getAllUserHomes" resultType="map">
        SELECT 
            user_id,
            building_name,
            contract_end,
            is_delete,
            CURDATE() as today,
            DATEDIFF(contract_end, CURDATE()) as days_until_expiry
        FROM myhome_tbl
        WHERE user_id = #{memberId}
        AND is_delete = 1
    </select>
    
    <!-- 동일한 사용자의 동일한 유형 미확인 알림 업데이트 -->
    <update id="updateAlarmText" parameterType="map">
        UPDATE alarm_tbl
        SET text = #{text},
            reg_date = NOW(),
            is_checked = 0
        WHERE member_id = #{memberId}
        AND type = #{type}
        AND is_checked = 0
        ORDER BY reg_date DESC
        LIMIT 1
    </update>
    
    <!-- 동일한 사용자의 동일한 유형 모든 알림 업데이트 (집 정보 수정 시) -->
    <update id="updateAllAlarmsByMemberAndType" parameterType="map">
        UPDATE alarm_tbl
        SET text = #{text},
            reg_date = NOW(),
            is_checked = 0
        WHERE member_id = #{memberId}
        AND type = #{type}
    </update>
    
    <!-- 동일한 사용자의 동일한 유형 알림 존재 여부 확인 -->
    <select id="existsAlarmByMemberAndType" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM alarm_tbl
        WHERE member_id = #{memberId}
        AND type = #{type}
    </select>
    
    <!-- 사용자의 type 1 알림 중 미확인 알림 개수 조회 -->
    <select id="getUnreadType1AlarmCount" resultType="int">
        SELECT COUNT(*)
        FROM alarm_tbl
        WHERE member_id = #{memberId}
        AND type = 1
        AND is_checked = 0
    </select>
    
    <!-- 사용자의 모든 type 1 알림 삭제 -->
    <delete id="deleteAllType1AlarmsByMember">
        DELETE FROM alarm_tbl
        WHERE member_id = #{memberId}
        AND type = 1
    </delete>
    
    <!-- 사용자가 관심을 갖는 건물의 시세 변동 감지 -->
    <select id="getPriceChangesForLikedEstates" resultType="map">
        SELECT 
            le.member_id,
            le.estate_id,
            le.building_name,
            eai.building_name as estate_building_name,
            eais.deal_amount,
            eais.deposit,
            eais.trade_type,
            eais.deal_year,
            eais.deal_month,
            eais.deal_day,
            eais.id as sales_id,
            le.update_date as liked_date
        FROM like_estate_tbl le
        JOIN estate_api_integration_tbl eai ON le.estate_id = eai.id
        JOIN estate_api_integration_sales_tbl eais ON eai.id = eais.estate_id
        WHERE le.member_id = #{memberId}
        AND le.is_like = 1
        ORDER BY eais.deal_year DESC, eais.deal_month DESC, eais.deal_day DESC
    </select>
    
    <!-- 특정 건물의 이전 거래 정보 조회 (찜한 시점 이전의 가장 최근 거래) -->
    <select id="getPreviousPriceForEstate" resultType="map">
        SELECT 
            deal_amount,
            deposit,
            trade_type,
            deal_year,
            deal_month,
            deal_day
        FROM estate_api_integration_sales_tbl
        WHERE estate_id = #{estateId}
            AND (
                deal_year &lt; #{likedYear}
                OR (deal_year = #{likedYear} AND deal_month &lt; #{likedMonth})
                OR (deal_year = #{likedYear} AND deal_month = #{likedMonth} AND deal_day &lt;= #{likedDay})
            )
        ORDER BY deal_year DESC, deal_month DESC, deal_day DESC
        LIMIT 1
    </select>

</mapper>