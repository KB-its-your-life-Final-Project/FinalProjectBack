<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lighthouse.alarm.mapper.AlarmMapper">

    <!-- 알림 저장 -->
    <insert id="insertAlarm" parameterType="com.lighthouse.alarm.entity.Alarms">
        INSERT INTO alarms_tbl(user_id,type,text,time,is_checked)
        VALUES(#{memberId},#{type},#{text},#{time},#{isChecked})
    </insert>

    <!-- 알림 설정 변경 -->
    <update id="updateAlarmSetting" parameterType="map">
        UPDATE alarm_tbl
        SET get_alarm = #{getAlarm}
        WHERE member_id = #{memberId}
        AND type = #{alarmType}
    </update>

    <!-- 제공 받을 알림 리스트 조회 -->
    <select id="getAlarmList" resultType="com.lighthouse.alarm.dto.AlarmResponseDto">
        SELECT 
            alarm_id,
            user_id as memberId,
            type,
            text,
            time,
            is_checked as isChecked
        FROM alarms_tbl
        WHERE user_id = #{memberId}
        AND is_checked = 0
        ORDER BY time DESC
    </select>

    <!-- 알림 읽음 처리 -->
    <update id="setAlarmRead" parameterMap="map">
        UPDATE alarm_tbl
        SET is_checked=1
        WHERE member_id=#{memberId}
        AND id=#{alarmId}
    </update>
    
    <!-- 만료 예정인 계약 목록 조회 (알림 생성용) -->
    <select id="getExpiringContracts" resultType="map">
        SELECT 
            h.member_id,
            h.address as property_address
        FROM home_register_tbl h
        WHERE h.contract_end_date = DATE_ADD(CURDATE(), INTERVAL #{daysLeft} DAY)
        AND h.is_active = 1
    </select>
    
    <!-- 관심 지역의 시세 변화 목록 조회 (알림 생성용) -->
    <select id="getInterestAreaPriceChanges" resultType="map">
        SELECT 
            w.member_id,
            w.area_name,
            CONCAT('변화율: ', ROUND((t.current_price - t.previous_price) / t.previous_price * 100, 2), '%') as change_info
        FROM wishlist_tbl w
        JOIN transactions_tbl t ON w.area_code = t.area_code
        WHERE t.update_date = CURDATE()
        AND ABS((t.current_price - t.previous_price) / t.previous_price) > 0.05
        AND w.is_active = 1
    </select>
    
    <!-- 특정 사용자의 만료 예정 계약 조회 -->
    <select id="getExpiringContractsByUser" resultType="map">
        SELECT 
            member_id,
            building_name as property_address
        FROM myhome_tbl
        WHERE member_id = #{memberId}
        AND contract_end = DATE_ADD(CURDATE(), INTERVAL #{daysLeft} DAY)
        AND is_delete = 1
    </select>
    
    <!-- 특정 사용자의 관심 지역 시세 변화 조회 -->
    <select id="getInterestAreaPriceChangesByUser" resultType="map">
        SELECT 
            w.member_id,
            w.area_name,
            CONCAT('변화율: ', ROUND((t.current_price - t.previous_price) / t.previous_price * 100, 2), '%') as change_info
        FROM wishlist_tbl w
        JOIN transactions_tbl t ON w.area_code = t.area_code
        WHERE w.member_id = #{memberId}
        AND t.update_date = CURDATE()
        AND ABS((t.current_price - t.previous_price) / t.previous_price) > 0.05
        AND w.is_active = 1
    </select>
    
    <!-- 모든 사용자 목록 조회 (알림 생성 대상) -->
    <select id="getAllUserIds" resultType="integer">
        SELECT DISTINCT member_id
        FROM member_tbl
        WHERE is_disable = 1
    </select>
</mapper>